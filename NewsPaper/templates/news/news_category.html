{% extends 'index.html' %}
{% load templtags %}
{%block content%}
{% load static %}

<button id="btn_sub" name="">Подписаться</button>


{% for query in queryset %}
<div class="news_detail" id="news_id">
    <h3>{{query.title | censor}}</h3>
    <p>{{query.create_date| date:'M d Y'}}</p>
    <p>{{query.text_post| truncatewords:24 | censor}}</p>
    {% url 'single_news' query.pk as url %}
    <a href="{{url}}">
        <button class="btn btn-outline-info" type="submit">Подробнее</button>
    </a>
</div>
{% endfor %}


<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Подписка оформлена!</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Закрыть"></button>
    </div>
    <div class="toast-body">
      Привет, {{user}}! Поздравляем за подписку в категории {{ object }}.
    </div>
  </div>
</div>

{% endblock%}



{% block script %}
<script>
const subChecker = () => {
    console.log('Началась функция')
    $.ajax({
        type : 'GET',
        url: `/news/subscribe/`,
        success : function(response){
        console.log(response)
        const subscribe_category = response.all_subscribe_category
        const button = document.getElementById('btn_sub')
            for (i = 0; i< subscribe_category.length; ++i) {
                    if ({{object.id}} === subscribe_category[i].category_id)
                        {button.className = "btn btn-success"
                        button.innerHTML = 'Вы подписаны'
                        break;}
                    else {button.className = "btn btn-primary"
                            button.innerHTML = 'Подписаться'}
                    }
            }
    })}

subChecker()


document.addEventListener('DOMContentLoaded', () => {

const button = document.getElementById('btn_sub');

button.addEventListener('click', () => {
        $.post( `{% url 'subscribe' %}` ,
        {'cat_id': {{object.id}}},
        function(data) {
            const btnStatus = document.getElementById('btn_sub')
            const toastLiveExample = document.getElementById('liveToast')
            const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
            if (data.status === true) {
                btnStatus.innerHTML = 'Вы подписаны'
                btnStatus.className = "btn btn-success"
                toastBootstrap.show()
                }
            else {
                btnStatus.innerHTML = 'Подписаться'
                btnStatus.className = "btn btn-primary"
                hidePopup()
                }
            })

        })
    })

</script>

{% endblock%}